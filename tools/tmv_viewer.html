<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>TMV Viewer</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
</head>

<body>
    <button onclick="exportSVGasPNG()">Export as PNG</button>
    <label for="svg-selector">Choose SVG file:</label>
    <select id="svg-selector">
        <option value="test.svg">test.svg</option>
        <option value="tmv_files.svg">tmv_files.svg</option>
        <option value="tmv_tools_binary.svg">tmv_tools_binary.svg</option>
        <option value="tmv_to_svg_nested.svg">tmv_to_svg_nested.svg</option>
        <option value="tmv_to_svg_linear_weights.svg">tmv_to_svg_linear_weights.svg</option>
    </select>
    <br />
    <br />
    <div id="svg-container"></div>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="info-box">Select/Hover over rects to see information</div>

    <style>
        rect {
            stroke-width: 0.05;
            stroke: black;
        }

        #info-box table {
            font-size: 16px;
            border-collapse: collapse;
            width: 800px;
            table-layout: fixed;
        }

        #info-box th,
        #info-box td {
            padding: 4px 8px;
            width: 50%;
            /* equal width columns */
            box-sizing: border-box;
        }

        #info-box th {
            border-bottom: 1px solid #aaa;
        }
    </style>

    <script>
        loadSVG("test.svg");

        function loadSVG(fileName) {
            fetch(fileName)
                .then(res => res.text())
                .then(svgText => {
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgText, "image/svg+xml");
                    const svgElement = svgDoc.documentElement;

                    // Ensure it has correct namespace
                    svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");

                    const container = document.getElementById("svg-container");
                    container.innerHTML = ""; // clear first
                    container.appendChild(svgElement);

                    requestAnimationFrame(initializeSVG);
                })
                .catch(err => {
                    console.error("Failed to load SVG:", err);
                    document.getElementById("svg-container").innerHTML = "<p>Error loading SVG file.</p>";
                });
        }

        document.getElementById("svg-selector").addEventListener("change", function () {
            const selectedFile = this.value;
            loadSVG(selectedFile);
        });

        function exportSVGasPNG(scale = 2) {
            const svgElement = document.querySelector("svg");
            const width = parseFloat(svgElement.getAttribute("width")) || 800;
            const height = parseFloat(svgElement.getAttribute("height")) || 600;

            const serializer = new XMLSerializer();
            let svgString = serializer.serializeToString(svgElement);

            if (!svgString.includes("xmlns=")) {
                svgString = svgString.replace(
                    "<svg",
                    `<svg xmlns="http://www.w3.org/2000/svg"`
                );
            }

            const blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(blob);

            const img = new Image();
            img.onload = function () {
                const canvas = document.getElementById("canvas");
                canvas.width = width * scale;
                canvas.height = height * scale;

                const ctx = canvas.getContext("2d");
                ctx.setTransform(scale, 0, 0, scale, 0, 0); // scale drawing
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                URL.revokeObjectURL(url);

                const pngURL = canvas.toDataURL("image/png");

                // Trigger download
                const a = document.createElement("a");
                a.href = pngURL;
                a.download = "exported.png";
                a.click();
            };

            img.onerror = function () {
                console.error("Failed to load SVG as image");
            };

            img.src = url;
        }

        function initializeSVG() {
            const svg = document.querySelector("svg");
            const infoBox = document.getElementById("info-box");

            let selectedRect = null;
            const darkFillCache = new Map();

            // Precompute darkened color to avoid repeated calculations
            function getDarkFill(originalFill) {
                if (darkFillCache.has(originalFill)) return darkFillCache.get(originalFill);

                let r = parseInt(originalFill.substr(1, 2), 16);
                let g = parseInt(originalFill.substr(3, 2), 16);
                let b = parseInt(originalFill.substr(5, 2), 16);

                r = Math.floor(r * 0.8).toString(16).padStart(2, "0");
                g = Math.floor(g * 0.8).toString(16).padStart(2, "0");
                b = Math.floor(b * 0.8).toString(16).padStart(2, "0");

                const dark = `#${r}${g}${b}`;
                darkFillCache.set(originalFill, dark);
                return dark;
            }

            function showData(rect) {
                const data = rect.dataset;
                let html = `<table><tr><th>Key</th><th>Value</th></tr>`;
                html += `<tr><td><strong>id</strong></td><td>${rect.id}</td></tr>`;
                html += `<tr><td><strong>rect.x</strong></td><td>${rect.getAttribute("x")}</td></tr>`;
                html += `<tr><td><strong>rect.y</strong></td><td>${rect.getAttribute("y")}</td></tr>`;
                html += `<tr><td><strong>rect.width</strong></td><td>${rect.getAttribute("width")}</td></tr>`;
                html += `<tr><td><strong>rect.height</strong></td><td>${rect.getAttribute("height")}</td></tr>`;
                html += `<tr><td><strong>rect.area</strong></td><td>${rect.getAttribute("height") * rect.getAttribute("width")}</td></tr>`;

                for (let key in data) {
                    if (key !== "originalFill") {
                        html += `<tr><td><strong>${key}</strong></td><td>${data[key]}</td></tr>`;
                    }
                }
                html += `</table>`;
                infoBox.innerHTML = html;
            }

            svg.addEventListener("click", (e) => {
                const rect = e.target.tagName === "rect" ? e.target : null;
                if (!rect) return;

                if (selectedRect === rect) {
                    // Unselect
                    rect.setAttribute("fill", rect.dataset.originalFill || rect.getAttribute("fill"));
                    delete rect.dataset.originalFill;
                    selectedRect = null;
                    infoBox.textContent = "Select/Hover over rects to see information";
                } else {
                    if (selectedRect) {
                        selectedRect.setAttribute("fill", selectedRect.dataset.originalFill);
                        delete selectedRect.dataset.originalFill;
                    }

                    const originalFill = rect.getAttribute("fill");
                    rect.dataset.originalFill = originalFill;
                    rect.setAttribute("fill", getDarkFill(originalFill));

                    selectedRect = rect;
                    showData(rect);
                }
            });

            svg.addEventListener("mouseover", (e) => {
                const rect = e.target.tagName === "rect" ? e.target : null;
                if (!rect || selectedRect) return;

                const originalFill = rect.getAttribute("fill");
                rect.dataset.originalFill = originalFill;
                rect.setAttribute("fill", getDarkFill(originalFill));
                showData(rect);
            });

            svg.addEventListener("mouseout", (e) => {
                const rect = e.target.tagName === "rect" ? e.target : null;
                if (!rect || selectedRect) return;

                if (rect.dataset.originalFill) {
                    rect.setAttribute("fill", rect.dataset.originalFill);
                    delete rect.dataset.originalFill;
                }
                infoBox.textContent = "Select/Hover over rects to see information";
            });
        }
    </script>

</body>

</html>