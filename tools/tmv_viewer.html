<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>TMV Viewer</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
</head>

<body>

    <div id="svg-container"></div>
    <div id="info-box">Select/Hover over rects to see information</div>

    <style>
        rect {
            stroke-width: 0.05;
            stroke: black;
        }

        #info-box table {
            font-size: 16px;
            border-collapse: collapse;
            width: 800px;
            table-layout: fixed;
        }

        #info-box th,
        #info-box td {
            padding: 4px 8px;
            width: 50%;
            /* equal width columns */
            box-sizing: border-box;
        }

        #info-box th {
            border-bottom: 1px solid #aaa;
        }
    </style>

    <script>
        fetch('tmv_files.svg')
            .then(res => res.text())
            .then(svgText => {
                document.getElementById("svg-container").innerHTML = svgText;
                requestAnimationFrame(initializeSVG); // defer to allow DOM paint
            });

        function initializeSVG() {
            const svg = document.querySelector("svg");
            const infoBox = document.getElementById("info-box");

            let selectedRect = null;
            const darkFillCache = new Map();

            // Precompute darkened color to avoid repeated calculations
            function getDarkFill(originalFill) {
                if (darkFillCache.has(originalFill)) return darkFillCache.get(originalFill);

                let r = parseInt(originalFill.substr(1, 2), 16);
                let g = parseInt(originalFill.substr(3, 2), 16);
                let b = parseInt(originalFill.substr(5, 2), 16);

                r = Math.floor(r * 0.8).toString(16).padStart(2, "0");
                g = Math.floor(g * 0.8).toString(16).padStart(2, "0");
                b = Math.floor(b * 0.8).toString(16).padStart(2, "0");

                const dark = `#${r}${g}${b}`;
                darkFillCache.set(originalFill, dark);
                return dark;
            }

            function showData(rect) {
                const data = rect.dataset;
                let html = `<table><tr><th>Key</th><th>Value</th></tr>`;
                html += `<tr><td><strong>id</strong></td><td>${rect.id}</td></tr>`;
                for (let key in data) {
                    if (key !== "originalFill") {
                        html += `<tr><td><strong>${key}</strong></td><td>${data[key]}</td></tr>`;
                    }
                }
                html += `</table>`;
                infoBox.innerHTML = html;
            }

            svg.addEventListener("click", (e) => {
                const rect = e.target.tagName === "rect" ? e.target : null;
                if (!rect) return;

                if (selectedRect === rect) {
                    // Unselect
                    rect.setAttribute("fill", rect.dataset.originalFill || rect.getAttribute("fill"));
                    delete rect.dataset.originalFill;
                    selectedRect = null;
                    infoBox.textContent = "Select/Hover over rects to see information";
                } else {
                    if (selectedRect) {
                        selectedRect.setAttribute("fill", selectedRect.dataset.originalFill);
                        delete selectedRect.dataset.originalFill;
                    }

                    const originalFill = rect.getAttribute("fill");
                    rect.dataset.originalFill = originalFill;
                    rect.setAttribute("fill", getDarkFill(originalFill));

                    selectedRect = rect;
                    showData(rect);
                }
            });

            svg.addEventListener("mouseover", (e) => {
                const rect = e.target.tagName === "rect" ? e.target : null;
                if (!rect || selectedRect) return;

                const originalFill = rect.getAttribute("fill");
                rect.dataset.originalFill = originalFill;
                rect.setAttribute("fill", getDarkFill(originalFill));
                showData(rect);
            });

            svg.addEventListener("mouseout", (e) => {
                const rect = e.target.tagName === "rect" ? e.target : null;
                if (!rect || selectedRect) return;

                if (rect.dataset.originalFill) {
                    rect.setAttribute("fill", rect.dataset.originalFill);
                    delete rect.dataset.originalFill;
                }
                infoBox.textContent = "Select/Hover over rects to see information";
            });
        }
    </script>

</body>

</html>